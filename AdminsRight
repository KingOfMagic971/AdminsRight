# AdminsRight
ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¿Ğ¾Ğ¼Ğ¾Ğ¶ĞµÑ‚ Ğ²Ğ°Ğ¼ ÑƒĞ´Ğ¾Ğ±Ğ½Ğ¾ Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ².
# -*- coding: utf-8 -*-
# meta developer: @Gosgrrr
# scope: hikka_only

import sqlite3
import json
from .. import loader, utils

DB_FILE = "admin_rights.db"

DEFAULT_RIGHTS = {
    'info': 0, 'post': 0, 'edit': 0,
    'delete': 1, 'ban': 1, 'invite': 1,
    'pin': 1, 'add_admins': 0, 'anon': 0, 'call': 1,
    'poststory': 0, 'editstory': 0, 'delstory': 0
}

class AdminRightsConfig(loader.Module):
    """âš™ï¸ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ°Ğ´Ğ¼Ğ¸Ğ½ÑĞºĞ¸Ğ¼Ğ¸ Ğ¿Ñ€Ğ°Ğ²Ğ°Ğ¼Ğ¸ Ğ¸ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³Ğ°Ğ¼Ğ¸"""

    strings = {"name": "AdminRights"}

    async def client_ready(self, client, db):
        self.db = db
        self._init_db()
        self.rights = self._load_rights()

    # ğŸ“‚ Ğ˜Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğ±Ğ°Ğ·Ñ‹
    def _init_db(self):
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute('''CREATE TABLE IF NOT EXISTS admin_rights_config (
            right_name TEXT PRIMARY KEY,
            is_enabled INTEGER
        )''')
        cursor.execute('''CREATE TABLE IF NOT EXISTS admin_presets (
            name TEXT PRIMARY KEY,
            rights TEXT
        )''')
        cursor.execute("SELECT COUNT(*) FROM admin_rights_config")
        if cursor.fetchone()[0] == 0:
            cursor.executemany(
                'INSERT INTO admin_rights_config (right_name, is_enabled) VALUES (?, ?)',
                list(DEFAULT_RIGHTS.items())
            )
        conn.commit()
        conn.close()

    # ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€Ğ°Ğ²
    def _load_rights(self):
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute("SELECT right_name, is_enabled FROM admin_rights_config")
        rights = {row[0]: bool(row[1]) for row in cursor.fetchall()}
        conn.close()
        return rights

    # ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ°
    def _save_right(self, right_name, is_enabled):
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute(
            'INSERT OR REPLACE INTO admin_rights_config (right_name, is_enabled) VALUES (?, ?)',
            (right_name, 1 if is_enabled else 0),
        )
        conn.commit()
        conn.close()
        self.rights[right_name] = is_enabled

    # ğŸ’¾ Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ğµ Ğ¿Ñ€ĞµÑĞµÑ‚Ğ°
    def _save_preset(self, name):
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute(
            'INSERT OR REPLACE INTO admin_presets (name, rights) VALUES (?, ?)',
            (name, json.dumps(self.rights)),
        )
        conn.commit()
        conn.close()

    # ğŸ”„ Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¿Ñ€ĞµÑĞµÑ‚Ğ°
    def _load_preset(self, name):
        conn = sqlite3.connect(DB_FILE)
        cursor = conn.cursor()
        cursor.execute('SELECT rights FROM admin_presets WHERE name = ?', (name,))
        row = cursor.fetchone()
        conn.close()
        if row:
            rights = json.loads(row[0])
            for k, v in rights.items():
                self._save_right(k, v)
            return True
        return False

    # ğŸ“‹ Ğ¤Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ñ‹Ğ¹ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ñ€Ğ°Ğ²
    def _format_rights(self):
        icons = {True: "âœ…", False: "âŒ"}
        names = {
            "info": "Ğ˜Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¸Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ğ¸ Ğ¾ Ğ³Ñ€ÑƒĞ¿Ğ¿Ğµ",
            "post": "ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²)",
            "edit": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ñ‡ÑƒĞ¶Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹ (Ğ´Ğ»Ñ ĞºĞ°Ğ½Ğ°Ğ»Ğ¾Ğ²)",
            "delete": "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ñ‡ÑƒĞ¶Ğ¸Ñ… ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹",
            "ban": "Ğ‘Ğ»Ğ¾ĞºĞ¸Ñ€Ğ¾Ğ²ĞºĞ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹",
            "invite": "ĞŸÑ€Ğ¸Ğ³Ğ»Ğ°ÑˆĞµĞ½Ğ¸Ğµ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹",
            "pin": "Ğ—Ğ°ĞºÑ€ĞµĞ¿Ğ»ĞµĞ½Ğ¸Ğµ ÑĞ¾Ğ¾Ğ±Ñ‰ĞµĞ½Ğ¸Ğ¹",
            "add_admins": "Ğ”Ğ¾Ğ±Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ½Ğ¾Ğ²Ñ‹Ñ… Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ²",
            "anon": "ĞĞ½Ğ¾Ğ½Ğ¸Ğ¼Ğ½Ğ°Ñ Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²ĞºĞ° (Ğ² Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ°Ñ…)",
            "call": "Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ²Ğ¸Ğ´ĞµĞ¾Ñ‡Ğ°Ñ‚Ğ°Ğ¼Ğ¸",
            "poststory": "ĞŸÑƒĞ±Ğ»Ğ¸ĞºĞ°Ñ†Ğ¸Ñ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¹",
            "editstory": "Ğ ĞµĞ´Ğ°ĞºÑ‚Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¹",
            "delstory": "Ğ£Ğ´Ğ°Ğ»ĞµĞ½Ğ¸Ğµ Ğ¸ÑÑ‚Ğ¾Ñ€Ğ¸Ğ¹",
        }
        text = "ğŸ”„ Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ .admin:\n\n"
        for right, enabled in self.rights.items():
            text += f"{icons[enabled]} {right} ({names[right]})\n"
        return text

    # ğŸ“Œ ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹

    async def admincmd(self, message):
        """[preset] [rank] - Ğ¿Ğ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ° Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€ĞµÑĞµÑ‚"""
        args = utils.get_args(message)
        if not args:
            await utils.answer(message, self._format_rights())
            return

        if len(args) >= 2:
            preset, rank = args[0], " ".join(args[1:])
            user = message.sender.first_name
            if self._load_preset(preset):
                await utils.answer(
                    message,
                    f"ğŸ›¡ {user} Ğ½Ğ°Ğ·Ğ½Ğ°Ñ‡ĞµĞ½(Ğ°) Ğ°Ğ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¾Ñ€Ğ¾Ğ¼ Ñ Ğ·Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼ Â«{rank}Â».",
                )
            else:
                await utils.answer(message, f"âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Â«{preset}Â» Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°.")

    async def adminsscmd(self, message):
        """<Ğ¿Ñ€Ğ°Ğ²Ğ¾> <on/off> - Ğ¸Ğ·Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ°Ğ²Ğ¾"""
        args = utils.get_args(message)
        if len(args) != 2:
            await utils.answer(message, "âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: .admins <Ğ¿Ñ€Ğ°Ğ²Ğ¾> <on/off>")
            return

        right, state = args
        if right not in self.rights:
            await utils.answer(message, f"âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ¾Ğµ Ğ¿Ñ€Ğ°Ğ²Ğ¾: {right}")
            return

        is_enabled = state.lower() == "on"
        self._save_right(right, is_enabled)

        status = "Ğ’ĞšĞ›Ğ®Ğ§Ğ•ĞĞ âœ…" if is_enabled else "Ğ’Ğ«ĞšĞ›Ğ®Ğ§Ğ•ĞĞ âŒ"
        await utils.answer(message, f"{status} Ğ¿Ñ€Ğ°Ğ²Ğ¾ **{right}** Ğ´Ğ»Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ .admin.")

    async def adminsavecmd(self, message):
        """<Ğ¸Ğ¼Ñ> - ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ Ñ‚ĞµĞºÑƒÑ‰ÑƒÑ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ"""
        args = utils.get_args(message)
        if not args:
            await utils.answer(message, "âŒ Ğ˜ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞ¹: .adminsave <Ğ¸Ğ¼Ñ>")
            return

        name = args[0]
        self._save_preset(name)
        await utils.answer(message, f"ğŸ’¾ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Â«{name}Â» ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ°.")
